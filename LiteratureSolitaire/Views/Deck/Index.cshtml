@model DeckViewModel
@using LiteratureSolitaire.Core.Models
@using LiteratureSolitaire.Extensions
@using LiteratureSolitaire.Core.Enumerations


@section Styles {
    <link rel="stylesheet" href="~/css/card.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/toast.css" asp-append-version="true" />
}

@{
    Layout = "_Layout";
    ViewData["HideFooter"] = true;
}

    <h2>Литературен пасианс</h2>

<form method="get" asp-action="Index" class="filter-bar" id="filterForm">
    <div class="filter-wrapper">
        <div class="category-grid">
            @foreach (CategorySorting c in Enum.GetValues(typeof(CategorySorting)))
            {
                var isChecked = Model.SelectedCategories?.Contains(c) == true;

                <label class="category-item">
                    <input type="checkbox"
                           name="categories"
                           value="@c"
                    @(isChecked ? "checked" : "") />
                    <span>@c.GetDisplayName()</span>
                </label>
            }
        </div>

        <div class="filter-buttons">
            <button type="submit" class="top-btn filter-btn">
                Филтрирай
            </button>

            <button type="button" class="top-btn clear-btn" onclick="clearFilter()">
                Изчисти
            </button>
        </div>
    </div>
</form>

<div class="top-row">
    <div id="deck" class="deck" onclick="drawCard()"></div>

    <div class="button-group">
        <button id="drawButton" class="top-btn" onclick="drawCard()">Тегли карта</button>
        <form asp-action="Shuffle" method="post">
            <input type="hidden" name="category" value="@Model.SelectedCategories" />
            <button type="submit" class="top-btn shuffle">Разбъркай</button>
        </form>
        <form asp-action="ValidateBoard" method="post">
            <button type="submit" class="top-btn validate">Провери</button>
        </form>
    </div>

    @{
        var drawn = Context.Session.GetObjectFromJson<List<LiteratureSolitaire.Core.Models.Card>>("drawn") ?? new();
    }

    <div id="drawPile"
         class="draw-pile">
        @foreach (var card in drawn)
        {
            <partial name="_CardPartial" model="card" />
        }
    </div>
</div>

<hr />

@if (TempData["CorrectCount"] != null)
{
    <div class="result-box">
        <span>Верни: @TempData["CorrectCount"] / 162</span>

        @if ((int)TempData["CorrectCount"] == 162)
        {
            <script>
                window.addEventListener("load", () => {
                    launchConfetti();
                });
            </script>
        }
    </div>
}

<h3>Игрално поле</h3>

<div id="board">
    @{
        var board = Context.Session.GetObjectFromJson<List<LiteratureSolitaire.Models.BoardSlot>>("board");
    }

    @for (int sec = 1; sec <= Model.SectionCount; sec++)
    {
        <div class="section">
            <div class="section-header">
                <h4>Раздел @sec</h4>
            </div>

            <div class="section-cards">
                @for (int pos = 1; pos <= 6; pos++)
                {
                    var slot = board?.FirstOrDefault(s => s.Section == sec && s.Position == pos);
                    <div class="drop-slot"
                         data-section="@sec"
                         data-position="@pos">
                        @if (slot?.Card != null)
                        {
                            <partial name="_CardPartial" model="slot.Card" />
                        }
                    </div>
                }
            </div>
        </div>
    }
</div>

<div id="toast-container"></div>

@section Scripts {
    <script src="~/js/card.js" asp-append-version="true"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
}